{{ define "main" }}
{{ block "header" . }}{{ partial "header" . }}{{end}}
<!-- wide page template -->
<div class="wrapper">

  <main class="main main--default">
    <div class="content">
      <div class="skr-container is-narrow pt-16 text-center">
        <div class="markdown">
          <div class="status-header">
            <img class="status-header__img" id="status-header-image" />
            <h1 id="status-header-title"></h1>
            <p id="status-header-text"></p>
          </div>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="skr-container pt-16 pb-24">
        <ul class="status-block status-list" id="status-list"></ul>
        <div class="status-list-legend">
          <div class="status-list-legend__labels">
            <div class="status-list-legend__label">
              <img src="status-good.svg" />
              Good
            </div>
            <div class="status-list-legend__label">
              <img src="status-disrupted.svg" />
              Disrupted
            </div>
            <div class="status-list-legend__label">
              <img src="status-outage.svg" />
              Outage
            </div>
          </div>
          <button class="status-history__show" id="show-history" type="button">See history</button>
        </div>
      </div>
    </div>

    <div class="status-history" id="history">
      <div class="content">
        <div class="skr-container pt-4 pb-4">
          <div class="markdown">
            <h2>History</h2>
          </div>
        </div>
      </div>
      <div class="content">
        <div class="skr-container pb-24">
          <div class="status-block">
            <table class="status-history__table" id="incidents-list"></table>
          </div>
        </div>
      </div>
    </div>

    <script>
      const statusApi = "https://status.skribble.com/api/v1/";

      document.getElementById('show-history').addEventListener('click', (event) => {
        let targetElement = event.target || event.srcElement;
        document.getElementById('history').style.display = 'block';
        targetElement.style.display = 'none';
      });

      function generateComponentStatus() {
        var componentRequest = new XMLHttpRequest();
        componentRequest.onload = function () {
          if (componentRequest.status >= 200 && componentRequest.status < 300) {
            showComponentStatus(componentRequest.responseText);
          } else {
            console.log("The ComponentRequest failed!");
          }
        };
        componentRequest.open("GET", statusApi + "components");
        componentRequest.send();
      }

      function showComponentStatus(statusJsonText) {
        let statusResult = JSON.parse(statusJsonText);
        let overallStatus = 1;
        statusResult.data.forEach((item) => {
          createComponentListEntry(item.name, item.status);
          if ([2, 3].includes(item.status)) {
            if (overallStatus < 4) {
              overallStatus = 3;
            }
          } else if ([4].includes(item.status)) {
            overallStatus = item.status;
          }
        });
        createHeaderForOverallStatus(overallStatus);
      }

      function createHeaderForOverallStatus(overallStatus) {
        let image = document.getElementById("status-header-image");
        let title = document.getElementById("status-header-title");
        let text = document.getElementById("status-header-text");
        if (overallStatus === 1) {
          image.src = "status-good-large.svg";
          title.textContent = "Skribble is up and running";
          text.innerHTML = "Having trouble? Check our help center or e-mail us at <a href=\"mailto:support@skribble.com\">support@skribble.com</a>";
        } else if (overallStatus === 3) {
          image.src = "status-disrupted-large.svg";
          title.textContent = "Skribble has limited service";
          text.innerHTML = "We are investigating issues with the „signing platform” and will provide updates here soon.";
        } else if (overallStatus == 4) {
          image.src = "status-outage-large.svg";
          title.textContent = "Skribble has a service outage";
          text.innerHTML = "We are investigating issues with the „signing platform” and will provide updates here soon.";
        }
      }

      function createComponentListEntry(name, status) {
        let liHead = document.createElement('liHead');
        let statusMsg, statusImgSrc;
        switch (status) {
          case 0:
          case 1:
            statusMsg = 'Operational'
            statusImgSrc = 'status-good.svg';
            break;
          case 2:
          case 3:
            statusMsg = 'Limited service';
            statusImgSrc = 'status-disrupted.svg';
            break;
          case 4:
            statusMsg = 'Outage';
            statusImgSrc = 'status-outage.svg';
            break;
        }
        let statusHtml = `<strong>${statusMsg}</strong><img class="status-list__status-img" src="${statusImgSrc}" />`;
        liHead.innerHTML = `<div class="status-list__label">${name}</div><div class="status-list__status">${statusHtml}</div>`;
        liHead.setAttribute('class', 'status-list__item');
        document.getElementById('status-list').appendChild(liHead);
      }

      function generateIncidentHistory() {
        var incidentRequest = new XMLHttpRequest();
        incidentRequest.onload = function () {
          if (incidentRequest.status >= 200 && incidentRequest.status < 300) {
            let incidentResult = JSON.parse(incidentRequest.responseText);
            incidentResult.data.forEach((item) => {
              creatIncidentListEntry(item);
            });
          } else {
            console.log("The IncidentRequest failed!");
          }
        };
        incidentRequest.open("GET", statusApi + "incidents?sort=occurred_at&order=desc");
        incidentRequest.send();
      }

      function creatIncidentListEntry(incident) {
        let messageText = (incident.message).replace(new RegExp('\r?\n','g'), '<br />');
        let liHead = document.createElement('tr');
        liHead.setAttribute('class', 'status-history__item');
        let date = new Date(incident.occurred_at)
        liHead.innerHTML = `<td class="status-history__td status-history__label"><strong>${incident.name}</strong></td>
                        <td class="status-history__date status-history__td">${date.getDate()}.${date.getMonth()}.${date.getFullYear()} - ${date.getHours()}:${date.getMinutes()}</td>`; 
        let liMessage = document.createElement('tr');                        
        liMessage.innerHTML = `<td class="status-history__td" colspan="2">${messageText}</td>`;
        document.getElementById('incidents-list').appendChild(liHead);
        document.getElementById('incidents-list').appendChild(liMessage);
        incident.updates.forEach((update) => {
          console.log(update);
          let liUpdate = createIncidentUpdateEntry(update);
          document.getElementById('incidents-list').appendChild(liUpdate);
        });
      }

      function createIncidentUpdateEntry(update){
        let messageText = (update.message).replace(new RegExp('\r?\n','g'), '<br />');
        let liUpdate = document.createElement('tr');
        liUpdate.innerHTML  = `<td class="status-history__td" colspan="2"><strong>UPDATE: ${update.human_status}</strong><br/>${messageText}</td></tr>`; 
        return liUpdate;
      }

      // Get the component status and incidents from
      // our status information system via API
      // and show the component status overview
      // and the incident history
      generateComponentStatus();
      generateIncidentHistory();
    </script>

  </main>
  {{ block "footer" . }}{{ partial "footer" . }}{{end}}
</div>
{{ end }}